{% extends "base.html" %}

{% block title %}Détails de la campagne - {{ app_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1><i class="fas fa-clipboard-list"></i> <span id="campainName">Chargement...</span></h1>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('web.dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Retour
            </a>
        </div>
    </div>
    
    <!-- Informations de la campagne -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-info-circle"></i> Informations
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Nom :</strong> <span id="detailName">-</span></p>
                            <p><strong>Description :</strong> <span id="detailDescription">-</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Créée le :</strong> <span id="detailDateCreated">-</span></p>
                            <p><strong>Créée par :</strong> <span id="detailUserCreated">-</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Section Fichiers -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-folder-open"></i> Fichiers</span>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadFileModal">
                        <i class="fas fa-upload"></i> Ajouter un fichier
                    </button>
                </div>
                <div class="card-body">
                    <div id="filesLoading" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                    </div>
                    <div id="filesContainer" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nom du fichier</th>
                                        <th>Taille (Ko)</th>
                                        <th>Date de modification</th>
                                        <th style="width: 150px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="filesTableBody">
                                    <!-- Les fichiers seront chargés ici -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div id="noFiles" style="display: none;" class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>Aucun fichier dans cette campagne</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Liste des tests -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-vial"></i> Tests de la campagne</span>
                    <a href="{{ url_for('web.add_test', campain_id=campain_id) }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus"></i> Ajouter un test
                    </a>
                </div>
                <div class="card-body">
                    <div id="testsLoading" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                    </div>
                    <div id="testsContainer" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Informations</th>
                                        <th>Types d'actions</th>
                                        <th>Date de création</th>
                                        <th style="width: 120px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="testsTableBody">
                                    <!-- Les tests seront chargés ici -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div id="noTests" style="display: none;" class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>Aucun test dans cette campagne</p>
                        <a href="{{ url_for('web.add_test', campain_id=campain_id) }}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Créer le premier test
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rapports d'exécution -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-chart-line"></i> Rapports d'exécution</span>
                    <button class="btn btn-sm btn-success" id="runCampainBtn" data-bs-toggle="modal" data-bs-target="#executeCampainModal">
                        <i class="fas fa-play"></i> Exécuter la campagne
                    </button>
                </div>
                <div class="card-body">
                    <div id="rapportsLoading" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                    </div>
                    <div id="rapportsContainer" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Date d'exécution</th>
                                        <th>Environnement</th>
                                        <th>Statut</th>
                                        <th>Progression</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="rapportsTableBody">
                                    <!-- Les rapports seront chargés ici -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div id="noRapports" style="display: none;" class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>Aucun rapport d'exécution</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modale d'exécution de campagne -->
<div class="modal fade" id="executeCampainModal" tabindex="-1" aria-labelledby="executeCampainModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="executeCampainModalLabel">
                    <i class="fas fa-play-circle"></i> Exécuter la campagne
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="executeCampainForm">
                    <div class="mb-3">
                        <label for="rapportName" class="form-label">Nom du rapport <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="rapportName" required>
                        <div class="form-text">Le nom sera généré automatiquement</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="filiere" class="form-label">Environnement <span class="text-danger">*</span></label>
                        <select class="form-select" id="filiere" required>
                            <option value="">Sélectionner un environnement...</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="stopOnFailure">
                            <label class="form-check-label" for="stopOnFailure">
                                Arrêter au premier échec
                            </label>
                            <div class="form-text">Si activé, l'exécution s'arrêtera dès qu'un test échoue</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="button" class="btn btn-success" id="launchCampainBtn">
                    <i class="fas fa-play"></i> Lancer la campagne
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modale d'upload de fichier -->
<div class="modal fade" id="uploadFileModal" tabindex="-1" aria-labelledby="uploadFileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadFileModalLabel">
                    <i class="fas fa-upload"></i> Ajouter un fichier
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadFileForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="fileInput" class="form-label">Fichier <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="fileInput" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="customFileName" class="form-label">Renommer le fichier (optionnel)</label>
                        <input type="text" class="form-control" id="customFileName" placeholder="Laissez vide pour conserver le nom original">
                        <div class="form-text">Vous pouvez renommer le fichier avant l'upload</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="button" class="btn btn-primary" id="uploadFileBtn">
                    <i class="fas fa-upload"></i> Uploader
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const campainId = '{{ campain_id }}';

// Chargement des détails de la campagne
async function loadCampainDetails() {
    try {
        const data = await API.get(`/api/campains/${campainId}`);
        
        document.getElementById('campainName').textContent = data.name;
        document.getElementById('detailName').textContent = data.name;
        document.getElementById('detailDescription').textContent = data.description || 'Aucune description';
        document.getElementById('detailDateCreated').textContent = new Date(data.dateCreated).toLocaleString('fr-FR');
        document.getElementById('detailUserCreated').textContent = data.userCreatedName || 'Utilisateur inconnu';
        
    } catch (error) {
        console.error('Erreur lors du chargement de la campagne:', error);
        showAlert('Erreur lors du chargement de la campagne', 'danger');
    }
}

// Chargement des tests de la campagne
async function loadTests() {
    try {
        const data = await API.get(`/api/tests?campain_id=${campainId}`);
        
        document.getElementById('testsLoading').style.display = 'none';
        
        if (data.data && data.data.length > 0) {
            document.getElementById('testsContainer').style.display = 'block';
            document.getElementById('noTests').style.display = 'none';
            
            const tbody = document.getElementById('testsTableBody');
            tbody.innerHTML = data.data.map(test => {
                const actionsCount = test.actions ? test.actions.length : 0;
                const actionTypes = test.actions ? [...new Set(test.actions.map(a => a.type))].join(', ') : '-';
                const testName = test.name || `Test #${test._id.substring(test._id.length - 6)}`;
                
                return `
                <tr>
                    <td>
                        <strong>${escapeHtml(testName)}</strong>
                        ${test.description ? `<br><small class="text-muted">${escapeHtml(test.description)}</small>` : ''}
                        <br><small class="text-muted">${actionsCount} action(s)</small>
                    </td>
                    <td>${actionTypes.split(', ').map(type => `<span class="badge bg-info me-1">${escapeHtml(type.toUpperCase())}</span>`).join('')}</td>
                    <td>${new Date(test.dateCreated).toLocaleString('fr-FR')}</td>
                    <td>
                        <div class="btn-group">
                            <a href="/campains/${campainId}/edit/test/${test._id}" class="btn btn-sm btn-outline-primary" title="Modifier">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTest('${test._id}')" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        } else {
            document.getElementById('testsContainer').style.display = 'none';
            document.getElementById('noTests').style.display = 'block';
        }
        
    } catch (error) {
        console.error('Erreur lors du chargement des tests:', error);
        document.getElementById('testsLoading').style.display = 'none';
        document.getElementById('noTests').style.display = 'block';
    }
}

// Chargement des rapports
async function loadRapports() {
    try {
        const data = await API.get(`/api/rapports?campain_id=${campainId}`);
        
        document.getElementById('rapportsLoading').style.display = 'none';
        
        if (data.data && data.data.length > 0) {
            document.getElementById('rapportsContainer').style.display = 'block';
            document.getElementById('noRapports').style.display = 'none';
            
            const tbody = document.getElementById('rapportsTableBody');
            tbody.innerHTML = data.data.map(rapport => {
                let statusBadge = '';
                let statusIcon = '';
                
                switch(rapport.status) {
                    case 'pending':
                        statusBadge = 'bg-secondary';
                        statusIcon = 'fa-clock';
                        break;
                    case 'running':
                        statusBadge = 'bg-primary';
                        statusIcon = 'fa-spinner fa-spin';
                        break;
                    case 'completed':
                        statusBadge = 'bg-success';
                        statusIcon = 'fa-check-circle';
                        break;
                    case 'failed':
                        statusBadge = 'bg-danger';
                        statusIcon = 'fa-times-circle';
                        break;
                }
                
                const progress = rapport.progress || 0;
                const progressBarClass = rapport.status === 'failed' ? 'bg-danger' : 'bg-success';
                
                return `
                    <tr>
                        <td><strong>${escapeHtml(rapport.details)}</strong></td>
                        <td>${new Date(rapport.dateCreated).toLocaleString('fr-FR')}</td>
                        <td><span class="badge bg-info">${escapeHtml(rapport.filiere)}</span></td>
                        <td><span class="badge ${statusBadge}"><i class="fas ${statusIcon}"></i> ${rapport.status}</span></td>
                        <td>
                            <div class="progress" style="width: 100px;">
                                <div class="progress-bar ${progressBarClass}" role="progressbar" 
                                     style="width: ${progress}%;" aria-valuenow="${progress}" 
                                     aria-valuemin="0" aria-valuemax="100">${progress}%</div>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewRapport('${rapport._id}')">
                                <i class="fas fa-eye"></i> Voir
                            </button>
                            <button class="btn btn-sm btn-danger ms-1" onclick="deleteRapport('${rapport._id}', '${escapeHtml(rapport.details)}')">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        } else {
            document.getElementById('rapportsContainer').style.display = 'none';
            document.getElementById('noRapports').style.display = 'block';
        }
        
    } catch (error) {
        console.error('Erreur lors du chargement des rapports:', error);
        document.getElementById('rapportsLoading').style.display = 'none';
        document.getElementById('noRapports').style.display = 'block';
    }
}

// Suppression d'un rapport
async function deleteRapport(rapportId, rapportName) {
    if (!confirm(`Êtes-vous sûr de vouloir supprimer le rapport "${rapportName}" ?`)) {
        return;
    }
    
    try {
        await API.delete(`/api/rapports/${rapportId}`);
        Notification.success('Rapport supprimé avec succès');
        loadRapports();
    } catch (error) {
        console.error('Erreur lors de la suppression du rapport:', error);
        Notification.error(error.message || 'Erreur lors de la suppression du rapport');
    }
}

// Suppression d'un test
async function deleteTest(testId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer ce test et toutes ses actions ?')) {
        return;
    }
    
    try {
        await API.delete(`/api/tests/${testId}`);
        Notification.success('Test supprimé avec succès');
        loadTests();
    } catch (error) {
        console.error('Erreur lors de la suppression du test:', error);
        Notification.error(error.message || 'Erreur lors de la suppression du test');
    }
}

// Chargement de la modale d'exécution
async function loadExecuteModal() {
    try {
        // Charger le nom généré
        const nameData = await API.get('/api/rapports/generate-name');
        document.getElementById('rapportName').value = nameData.name;
        
        // Charger les filières
        const filieresData = await API.get('/api/rapports/filieres');
        const filiereSelect = document.getElementById('filiere');
        filiereSelect.innerHTML = '<option value="">Sélectionner un environnement...</option>';
        
        filieresData.filieres.forEach(filiere => {
            const option = document.createElement('option');
            option.value = filiere;
            option.textContent = filiere;
            filiereSelect.appendChild(option);
        });
        
    } catch (error) {
        console.error('Erreur lors du chargement de la modale:', error);
        Notification.error('Erreur lors du chargement des données');
    }
}

// Lancement de la campagne
document.getElementById('launchCampainBtn').addEventListener('click', async () => {
    const name = document.getElementById('rapportName').value.trim();
    const filiere = document.getElementById('filiere').value;
    const stopOnFailure = document.getElementById('stopOnFailure').checked;
    
    if (!name) {
        Notification.error('Le nom du rapport est obligatoire');
        return;
    }
    
    if (!filiere) {
        Notification.error('L\'environnement est obligatoire');
        return;
    }
    
    try {
        const btn = document.getElementById('launchCampainBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Lancement...';
        
        const result = await API.post('/api/rapports/execute', {
            campain_id: campainId,
            name: name,
            filiere: filiere,
            stop_on_failure: stopOnFailure
        });
        
        Notification.success('Campagne lancée avec succès');
        
        // Fermer la modale
        const modal = bootstrap.Modal.getInstance(document.getElementById('executeCampainModal'));
        modal.hide();
        
        // Recharger les rapports
        setTimeout(() => {
            loadRapports();
        }, 1000);
        
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play"></i> Lancer la campagne';
        
    } catch (error) {
        console.error('Erreur lors du lancement de la campagne:', error);
        Notification.error(error.message || 'Erreur lors du lancement de la campagne');
        
        const btn = document.getElementById('launchCampainBtn');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play"></i> Lancer la campagne';
    }
});

// Charger la modale quand elle s'ouvre
document.getElementById('executeCampainModal').addEventListener('show.bs.modal', loadExecuteModal);

// Visualisation d'un rapport
function viewRapport(rapportId) {
    window.location.href = `/rapports/${rapportId}`;
}

// Fonction utilitaire pour échapper le HTML
function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return String(text).replace(/[&<>"']/g, m => map[m]);
}

// ===== GESTION DES FICHIERS =====

// Chargement de la liste des fichiers
async function loadFiles() {
    try {
        const data = await API.get(`/api/campains/${campainId}/files`);
        
        document.getElementById('filesLoading').style.display = 'none';
        
        if (data.files && data.files.length > 0) {
            document.getElementById('filesContainer').style.display = 'block';
            document.getElementById('noFiles').style.display = 'none';
            
            const tbody = document.getElementById('filesTableBody');
            tbody.innerHTML = data.files.map(file => {
                const modifiedDate = new Date(file.modified).toLocaleString('fr-FR');
                
                return `
                <tr>
                    <td>
                        <i class="fas fa-file"></i> ${escapeHtml(file.name)}
                    </td>
                    <td>${file.size}</td>
                    <td>${modifiedDate}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="downloadFile('${escapeHtml(file.name)}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteFile('${escapeHtml(file.name)}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
        } else {
            document.getElementById('filesContainer').style.display = 'none';
            document.getElementById('noFiles').style.display = 'block';
        }
        
    } catch (error) {
        console.error('Erreur lors du chargement des fichiers:', error);
        document.getElementById('filesLoading').style.display = 'none';
        document.getElementById('noFiles').style.display = 'block';
    }
}

// Upload d'un fichier
document.getElementById('uploadFileBtn').addEventListener('click', async () => {
    const fileInput = document.getElementById('fileInput');
    const customFileName = document.getElementById('customFileName').value.trim();
    
    if (!fileInput.files || fileInput.files.length === 0) {
        Notification.warning('Veuillez sélectionner un fichier');
        return;
    }
    
    const file = fileInput.files[0];
    const formData = new FormData();
    formData.append('file', file);
    
    if (customFileName) {
        formData.append('customName', customFileName);
    }
    
    const btn = document.getElementById('uploadFileBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Upload en cours...';
    
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/campains/${campainId}/files`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.message || 'Erreur lors de l\'upload');
        }
        
        Notification.success(data.message || 'Fichier uploadé avec succès');
        
        // Fermer la modale
        const modal = bootstrap.Modal.getInstance(document.getElementById('uploadFileModal'));
        modal.hide();
        
        // Réinitialiser le formulaire
        document.getElementById('uploadFileForm').reset();
        
        // Recharger la liste des fichiers (sera aussi fait via WebSocket)
        loadFiles();
        
    } catch (error) {
        console.error('Erreur lors de l\'upload:', error);
        Notification.error(error.message || 'Erreur lors de l\'upload du fichier');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-upload"></i> Uploader';
    }
});

// Téléchargement d'un fichier
function downloadFile(filename) {
    const token = localStorage.getItem('token');
    window.location.href = `/api/campains/${campainId}/files/${encodeURIComponent(filename)}?token=${token}`;
}

// Suppression d'un fichier
async function deleteFile(filename) {
    if (!confirm(`Êtes-vous sûr de vouloir supprimer le fichier "${filename}" ?`)) {
        return;
    }
    
    try {
        await API.delete(`/api/campains/${campainId}/files/${encodeURIComponent(filename)}`);
        Notification.success('Fichier supprimé avec succès');
        
        // Recharger la liste des fichiers (sera aussi fait via WebSocket)
        loadFiles();
        
    } catch (error) {
        console.error('Erreur lors de la suppression:', error);
        Notification.error(error.message || 'Erreur lors de la suppression du fichier');
    }
}

// WebSocket pour les mises à jour en temps réel des fichiers
const socket = io();

// Rejoindre la room de la campagne
socket.emit('join', { room: `campain_${campainId}` });

// Écouter les événements de mise à jour des fichiers
socket.on('files_updated', (data) => {
    if (data.campain_id === campainId) {
        loadFiles();
    }
});

// Chargement initial
document.addEventListener('DOMContentLoaded', () => {
    loadCampainDetails();
    loadFiles();
    loadTests();
    loadRapports();
});
</script>
{% endblock %}
