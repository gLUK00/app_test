{% extends "base.html" %}

{% block title %}Exécution du test - {{ app_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1><i class="fas fa-play-circle"></i> Exécution du test</h1>
        </div>
        <div class="col-md-4 text-end">
            <a href="#" id="btnRetour" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Retour
            </a>
        </div>
    </div>

    <!-- Informations du test -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-info-circle"></i> Informations du test
                </div>
                <div class="card-body">
                    <div id="testLoading" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                    </div>
                    <div id="testInfo" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Nom :</strong> <span id="testName">-</span></p>
                                <p><strong>Description :</strong> <span id="testDescription">-</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Nombre d'actions :</strong> <span id="testActionsCount">-</span></p>
                                <p><strong>Variables du test :</strong> <span id="testVariables">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sélection de l'environnement et lancement -->
    <div class="row mb-4" id="executionControls">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-cog"></i> Configuration d'exécution
                </div>
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-6">
                            <label for="selectFiliere" class="form-label">Environnement :</label>
                            <select id="selectFiliere" class="form-select">
                                <option value="">Chargement...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <button id="btnExecute" class="btn btn-success" disabled>
                                <i class="fas fa-play"></i> Lancer le test
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statut d'exécution -->
    <div class="row mb-4" id="executionStatus" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-line"></i> Statut d'exécution
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12 text-center">
                            <h4>
                                <span id="statusBadge" class="badge bg-secondary">
                                    <i class="fas fa-clock"></i> En attente
                                </span>
                            </h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs d'exécution -->
    <div class="row mb-4" id="executionLogs" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-file-alt"></i> Logs d'exécution</span>
                    <button id="btnClearLogs" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-eraser"></i> Effacer
                    </button>
                </div>
                <div class="card-body">
                    <pre id="logsContent" class="border p-3" style="max-height: 500px; overflow-y: auto; background-color: #1e1e1e; color: #d4d4d4; font-family: 'Courier New', monospace; font-size: 14px;"></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const testId = '{{ test_id }}';
    let socket = null;
    let testData = null;
    
    // Charger les informations du test
    async function loadTestInfo() {
        try {
            testData = await API.get(`/api/tests/${testId}`);
            
            document.getElementById('testName').textContent = testData.name || 'Sans nom';
            document.getElementById('testDescription').textContent = testData.description || 'Aucune description';
            document.getElementById('testActionsCount').textContent = testData.actions ? testData.actions.length : 0;
            
            // Afficher les variables du test
            if (testData.variables && testData.variables.length > 0) {
                const varsHtml = testData.variables.map(v => `<span class="badge bg-success me-1">${v}</span>`).join('');
                document.getElementById('testVariables').innerHTML = varsHtml;
            } else {
                document.getElementById('testVariables').textContent = 'Aucune';
            }
            
            // Mettre à jour le bouton retour
            if (testData.campainId) {
                document.getElementById('btnRetour').href = `/campains/${testData.campainId}`;
            } else {
                document.getElementById('btnRetour').href = '/dashboard';
            }
            
            document.getElementById('testLoading').style.display = 'none';
            document.getElementById('testInfo').style.display = 'block';
            
        } catch (error) {
            console.error('Erreur:', error);
            Notification.error('Erreur lors du chargement du test');
        }
    }
    
    // Charger les filières
    async function loadFilieres() {
        try {
            const filieres = await API.get('/api/tests/filieres');
            const select = document.getElementById('selectFiliere');
            
            select.innerHTML = '<option value="">Sélectionnez un environnement</option>';
            
            filieres.forEach(filiere => {
                const option = document.createElement('option');
                option.value = filiere;
                option.textContent = filiere;
                select.appendChild(option);
            });
            
            // Activer le bouton si une filière est sélectionnée
            select.addEventListener('change', () => {
                document.getElementById('btnExecute').disabled = !select.value;
            });
            
        } catch (error) {
            console.error('Erreur:', error);
            Notification.error('Erreur lors du chargement des environnements');
        }
    }
    
    // Initialiser le WebSocket
    function initSocket() {
        socket = io();
        
        socket.on('connect', function() {
            console.log('WebSocket connecté');
            // Rejoindre la room du test
            socket.emit('join_test', { test_id: testId });
            console.log('Demande de join à la room:', `test_${testId}`);
        });
        
        // Écouter TOUS les événements pour debug
        socket.onAny((eventName, ...args) => {
            console.log('[WebSocket] Événement reçu:', eventName, args);
        });
        
        socket.on('test_started', function(data) {
            console.log('Test démarré:', data);
            updateStatus('running', 'En cours');
            
            // Désactiver les contrôles
            document.getElementById('executionControls').style.display = 'none';
            
            // Afficher les logs
            document.getElementById('executionLogs').style.display = 'block';
        });
        
        socket.on('test_log', function(data) {
            console.log('Log reçu:', data);
            addLog(data.log);
        });
        
        socket.on('test_completed', function(data) {
            console.log('Test terminé:', data);
            updateStatus(data.status, data.status === 'passed' ? 'Réussi' : 'Échoué');
        });
        
        socket.on('disconnect', function() {
            console.log('WebSocket déconnecté');
        });
    }
    
    // Mettre à jour le statut
    function updateStatus(status, text) {
        const statusBadge = document.getElementById('statusBadge');
        document.getElementById('executionStatus').style.display = 'block';
        
        statusBadge.className = 'badge';
        
        if (status === 'running') {
            statusBadge.classList.add('bg-primary');
            statusBadge.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + text;
        } else if (status === 'passed') {
            statusBadge.classList.add('bg-success');
            statusBadge.innerHTML = '<i class="fas fa-check-circle"></i> ' + text;
        } else if (status === 'failed') {
            statusBadge.classList.add('bg-danger');
            statusBadge.innerHTML = '<i class="fas fa-times-circle"></i> ' + text;
        } else {
            statusBadge.classList.add('bg-secondary');
            statusBadge.innerHTML = '<i class="fas fa-clock"></i> ' + text;
        }
    }
    
    // Ajouter un log
    function addLog(log) {
        const logsContent = document.getElementById('logsContent');
        logsContent.textContent += log + '\n';
        
        // Scroll automatique vers le bas
        logsContent.scrollTop = logsContent.scrollHeight;
    }
    
    // Lancer l'exécution
    async function executeTest() {
        const filiere = document.getElementById('selectFiliere').value;
        
        if (!filiere) {
            Notification.error('Veuillez sélectionner un environnement');
            return;
        }
        
        try {
            updateStatus('pending', 'Lancement...');
            document.getElementById('executionStatus').style.display = 'block';
            
            const result = await API.post(`/api/tests/${testId}/execute`, { filiere });
            console.log('Exécution lancée:', result);
            
        } catch (error) {
            console.error('Erreur:', error);
            Notification.error('Erreur lors du lancement du test: ' + error.message);
            updateStatus('failed', 'Erreur');
        }
    }
    
    // Effacer les logs
    function clearLogs() {
        document.getElementById('logsContent').textContent = '';
    }
    
    // Initialisation au chargement
    document.addEventListener('DOMContentLoaded', async () => {
        await loadTestInfo();
        await loadFilieres();
        initSocket();
        
        // Événements
        document.getElementById('btnExecute').addEventListener('click', executeTest);
        document.getElementById('btnClearLogs').addEventListener('click', clearLogs);
    });
</script>
{% endblock %}
