{% extends "base.html" %}

{% block title %}Ajouter un test - {{ app_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1><i class="fas fa-plus-circle"></i> Ajouter un test</h1>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('web.campain_details', campain_id=campain_id) }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Retour
            </a>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-10 mx-auto">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-vial"></i> Informations du test
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="testName" class="form-label">Nom du test *</label>
                        <input type="text" class="form-control" id="testName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="testDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="testDescription" rows="3"></textarea>
                    </div>
                </div>
            </div>

            <!-- Liste des actions -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-tasks"></i> Actions du test</span>
                    <div>
                        <button type="button" class="btn btn-sm btn-info" id="addVariableBtn">
                            <i class="fas fa-plus"></i> Ajouter une variable
                        </button>
                        <button type="button" class="btn btn-sm btn-success" id="addActionBtn">
                            <i class="fas fa-plus"></i> Ajouter une action
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Liste des variables -->
                    <div id="variablesList" class="mb-3"></div>
                    
                    <!-- Liste des actions -->
                    <div id="actionsList">
                        <p class="text-muted text-center">Aucune action ajoutée. Cliquez sur "Ajouter une action" pour commencer.</p>
                    </div>
                </div>
            </div>

            <!-- Bouton de soumission -->
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-primary btn-lg" id="submitTestBtn">
                    <i class="fas fa-save"></i> Créer le test
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour ajouter/éditer une action -->
<div class="modal fade" id="actionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="actionModalTitle">Ajouter une action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="actionForm">
                    <div class="mb-3">
                        <label for="actionType" class="form-label">Type d'action *</label>
                        <select class="form-select" id="actionType" required>
                            <option value="">-- Sélectionner un type --</option>
                            <option value="http">HTTP Request</option>
                            <option value="ftp">FTP</option>
                            <option value="sftp">SFTP</option>
                            <option value="ssh">SSH</option>
                            <option value="webdav">WebDAV</option>
                        </select>
                    </div>
                    
                    <!-- Zone dynamique pour les champs spécifiques au type d'action -->
                    <div id="dynamicFields"></div>
                    
                    <!-- Zone pour les variables de sortie -->
                    <div id="outputVariablesSection" style="display: none;" class="mt-4">
                        <hr>
                        <h6 class="text-primary"><i class="fas fa-output"></i> Variables de sortie</h6>
                        <p class="text-muted small">Sélectionnez les variables de sortie que vous souhaitez rendre disponibles pour les actions suivantes.</p>
                        <div id="outputVariablesList"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="saveActionBtn">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour ajouter une variable -->
<div class="modal fade" id="variableModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter une variable</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="variableForm">
                    <div class="mb-3">
                        <label for="variableName" class="form-label">Nom de la variable *</label>
                        <input type="text" class="form-control" id="variableName" required 
                               pattern="[a-zA-Z0-9_]+" 
                               placeholder="Ex: ma_variable"
                               data-var-autocomplete="disabled">
                        <small class="form-text text-muted">Caractères alphanumériques et underscore uniquement</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="saveVariableBtn">Ajouter</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
    const campainId = '{{ campain_id }}';
    let actionMasks = {};
    let actionOutputVariables = {};
    let actions = [];
    let variables = [];
    let editingActionIndex = -1;
    let actionModal;
    let variableModal;
    
    // Charger tous les masques de saisie et les variables de sortie au chargement de la page
    async function loadActionMasks() {
        try {
            const result = await API.get('/api/actions/masks');
            actionMasks = result;
        } catch (error) {
            console.error('Erreur lors du chargement des masques:', error);
            Notification.error('Erreur lors du chargement des types d\'actions');
        }
    }
    
    async function loadActionOutputVariables() {
        try {
            const result = await API.get('/api/actions/output-variables');
            actionOutputVariables = result;
            console.log('Action output variables chargées:', actionOutputVariables);
        } catch (error) {
            console.error('Erreur lors du chargement des variables de sortie:', error);
        }
    }
    
    // Fonction pour générer un champ de formulaire dynamiquement
    function createFormField(field) {
        const divWrapper = document.createElement('div');
        divWrapper.className = 'mb-3';
        
        const label = document.createElement('label');
        label.className = 'form-label';
        label.setAttribute('for', field.name);
        label.textContent = field.label + (field.required ? ' *' : '');
        divWrapper.appendChild(label);
        
        let input;
        
        if (field.type === 'select') {
            input = document.createElement('select');
            input.className = 'form-select';
            
            // Option par défaut
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- Sélectionner --';
            input.appendChild(defaultOption);
            
            // Ajouter les options
            field.options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                input.appendChild(opt);
            });
        } else if (field.type === 'textarea') {
            input = document.createElement('textarea');
            input.className = 'form-control';
            input.rows = 3;
        } else if (field.type === 'number') {
            input = document.createElement('input');
            input.type = 'number';
            input.className = 'form-control';
        } else {
            // Par défaut, input text
            input = document.createElement('input');
            input.type = field.type === 'string' ? 'text' : field.type;
            input.className = 'form-control';
        }
        
        input.id = field.name;
        input.name = field.name;
        
        if (field.placeholder) {
            input.placeholder = field.placeholder;
        }
        
        if (field.required) {
            input.required = true;
        }
        
        divWrapper.appendChild(input);
        
        // Ajouter un texte d'aide si nécessaire
        if (field.name === 'headers' || field.name === 'body') {
            const small = document.createElement('small');
            small.className = 'form-text text-muted';
            small.textContent = 'Format JSON valide';
            divWrapper.appendChild(small);
        }
        
        return divWrapper;
    }
    
    // Fonction pour afficher les champs dynamiques selon le type sélectionné
    function displayDynamicFields(actionType, currentParameters = {}) {
        const dynamicFieldsContainer = document.getElementById('dynamicFields');
        dynamicFieldsContainer.innerHTML = '';
        
        if (!actionType || !actionMasks[actionType]) {
            document.getElementById('outputVariablesSection').style.display = 'none';
            return;
        }
        
        const mask = actionMasks[actionType];
        mask.forEach(field => {
            const fieldElement = createFormField(field);
            dynamicFieldsContainer.appendChild(fieldElement);
            
            // Remplir avec les valeurs existantes si on édite
            if (currentParameters && currentParameters[field.name]) {
                const input = fieldElement.querySelector(`#${field.name}`);
                if (input) {
                    const value = currentParameters[field.name];
                    if (typeof value === 'object') {
                        input.value = JSON.stringify(value, null, 2);
                    } else {
                        input.value = value;
                    }
                }
            }
        });
        
        // Afficher les variables de sortie disponibles
        displayOutputVariables(actionType, currentParameters.output_mapping || {});
    }
    
    // Fonction pour afficher les variables de sortie disponibles
    function displayOutputVariables(actionType, currentMapping = {}) {
        const outputSection = document.getElementById('outputVariablesSection');
        const outputList = document.getElementById('outputVariablesList');
        
        if (!actionType || !actionOutputVariables[actionType] || actionOutputVariables[actionType].length === 0) {
            outputSection.style.display = 'none';
            return;
        }
        
        outputSection.style.display = 'block';
        outputList.innerHTML = '';
        
        const outputVars = actionOutputVariables[actionType];
        outputVars.forEach(outputVar => {
            const div = document.createElement('div');
            div.className = 'mb-3 p-3 border rounded';
            
            let html = `
                <div class="form-check mb-2">
                    <input class="form-check-input output-var-checkbox" type="checkbox" 
                           id="output_${outputVar.name}" 
                           data-var-name="${outputVar.name}"
                           ${currentMapping[outputVar.name] ? 'checked' : ''}>
                    <label class="form-check-label fw-bold" for="output_${outputVar.name}">
                        ${outputVar.name}
                    </label>
                </div>
                <small class="text-muted d-block mb-2">${outputVar.description}</small>
                <div class="output-mapping-section" id="mapping_${outputVar.name}" 
                     style="display: ${currentMapping[outputVar.name] ? 'block' : 'none'};">
                    <label class="form-label small">Mapper à la variable du test:</label>
                    <select class="form-select form-select-sm output-var-mapping" 
                            data-var-name="${outputVar.name}">
                        <option value="">-- Sélectionner une variable --</option>
                        ${variables.map(v => `<option value="${v}" ${currentMapping[outputVar.name] === v ? 'selected' : ''}>${v}</option>`).join('')}
                    </select>
                </div>
            `;
            
            div.innerHTML = html;
            outputList.appendChild(div);
            
            // Gérer l'affichage du mapping
            const checkbox = div.querySelector('.output-var-checkbox');
            const mappingSection = div.querySelector('.output-mapping-section');
            
            checkbox.addEventListener('change', (e) => {
                mappingSection.style.display = e.target.checked ? 'block' : 'none';
            });
        });
    }
    
    // Écouter le changement du type d'action
    document.getElementById('actionType').addEventListener('change', (e) => {
        displayDynamicFields(e.target.value);
    });
    
    // Fonction pour ouvrir le modal d'ajout d'action
    document.getElementById('addActionBtn').addEventListener('click', () => {
        editingActionIndex = -1;
        document.getElementById('actionModalTitle').textContent = 'Ajouter une action';
        document.getElementById('actionForm').reset();
        document.getElementById('dynamicFields').innerHTML = '';
        document.getElementById('outputVariablesSection').style.display = 'none';
        actionModal.show();
    });
    
    // Fonction pour éditer une action
    window.editAction = (index) => {
        editingActionIndex = index;
        const action = actions[index];
        
        document.getElementById('actionModalTitle').textContent = 'Modifier une action';
        document.getElementById('actionType').value = action.type;
        
        displayDynamicFields(action.type, action.value);
        actionModal.show();
    };
    
    // Fonction pour formater et afficher les données "value" de manière indentée
    function formatActionValue(value) {
        if (!value || typeof value !== 'object' || Object.keys(value).length === 0) {
            return '';
        }
        
        let html = '<div class="mt-2" style="font-size: 0.85rem;">';
        html += '<div class="text-muted mb-1"><strong>Paramètres :</strong></div>';
        html += '<div style="font-family: monospace; background-color: #f8f9fa; padding: 8px; border-radius: 4px; border-left: 3px solid #0d6efd;">';
        
        for (const [key, val] of Object.entries(value)) {
            // Exclure output_mapping de l'affichage car ce n'est pas un paramètre de l'action
            if (key === 'output_mapping') {
                continue;
            }
            
            if (val !== null && val !== undefined && val !== '') {
                let displayValue = val;
                
                // Formater les objets JSON
                if (typeof val === 'object') {
                    displayValue = JSON.stringify(val, null, 2);
                    html += `<div style="margin-bottom: 6px;">`;
                    html += `<span style="color: #0d6efd; font-weight: 500;">${key}:</span>`;
                    html += `<pre style="margin: 2px 0 0 20px; font-size: 0.8rem; color: #495057;">${displayValue}</pre>`;
                    html += `</div>`;
                } else {
                    // Tronquer les valeurs trop longues
                    if (typeof displayValue === 'string' && displayValue.length > 100) {
                        displayValue = displayValue.substring(0, 100) + '...';
                    }
                    html += `<div style="margin-bottom: 4px; margin-left: 0px;">`;
                    html += `<span style="color: #0d6efd; font-weight: 500;">${key}:</span> `;
                    html += `<span style="color: #495057;">${displayValue}</span>`;
                    html += `</div>`;
                }
            }
        }
        
        html += '</div></div>';
        return html;
    }
    
    // Fonction pour afficher la liste des actions
    function renderActionsList() {
        const actionsList = document.getElementById('actionsList');
        
        if (actions.length === 0) {
            actionsList.innerHTML = '<p class="text-muted text-center">Aucune action ajoutée. Cliquez sur "Ajouter une action" pour commencer.</p>';
            return;
        }
        
        actionsList.innerHTML = actions.map((action, index) => {
            // Récupérer les variables de sortie mappées pour cette action
            let outputBadges = '';
            if (action.value && action.value.output_mapping && Object.keys(action.value.output_mapping).length > 0) {
                const outputMapping = action.value.output_mapping;
                const availableOutputVars = actionOutputVariables[action.type] || [];
                
                console.log('Action type:', action.type);
                console.log('Available output vars:', availableOutputVars);
                console.log('Output mapping:', outputMapping);
                
                outputBadges = Object.entries(outputMapping).map(([outputVar, testVar]) => {
                    // Vérifier si la variable du test existe toujours dans la liste des variables du test
                    const isTestVarDefined = variables.includes(testVar);
                    const badgeColor = isTestVarDefined ? 'success' : 'secondary';
                    
                    console.log(`Variable ${outputVar} → ${testVar}: isTestVarDefined=${isTestVarDefined}, color=${badgeColor}`);
                    
                    return `<span class="badge bg-${badgeColor} me-1" style="font-size: 0.75rem;">${outputVar} → ${testVar}</span>`;
                }).join('');
            }
            
            return `
            <div class="card mb-2 action-item" data-index="${index}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-secondary me-2">#${index + 1}</span>
                                    <h6 class="mb-0">Action ${action.type.toUpperCase()}</h6>
                                    <span class="badge bg-primary ms-2">${action.type.toUpperCase()}</span>
                                </div>
                                ${outputBadges ? `<div class="d-flex align-items-center flex-wrap">${outputBadges}</div>` : ''}
                            </div>
                            ${formatActionValue(action.value)}
                        </div>
                        <div class="btn-group ms-3" style="flex-shrink: 0;">
                            ${index > 0 ? `<button class="btn btn-sm btn-outline-secondary" onclick="moveAction(${index}, -1)" title="Monter">
                                <i class="fas fa-arrow-up"></i>
                            </button>` : ''}
                            ${index < actions.length - 1 ? `<button class="btn btn-sm btn-outline-secondary" onclick="moveAction(${index}, 1)" title="Descendre">
                                <i class="fas fa-arrow-down"></i>
                            </button>` : ''}
                            <button class="btn btn-sm btn-outline-primary" onclick="editAction(${index})" title="Modifier">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAction(${index})" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        }).join('');
    }
    
    // Fonction pour ouvrir le modal d'ajout d'action
    document.getElementById('addActionBtn').addEventListener('click', () => {
        editingActionIndex = -1;
        document.getElementById('actionModalTitle').textContent = 'Ajouter une action';
        document.getElementById('actionForm').reset();
        document.getElementById('dynamicFields').innerHTML = '';
        actionModal.show();
    });
    
    // Fonction pour éditer une action
    window.editAction = (index) => {
        editingActionIndex = index;
        const action = actions[index];
        
        document.getElementById('actionModalTitle').textContent = 'Modifier l\'action';
        document.getElementById('actionType').value = action.type;
        
        displayDynamicFields(action.type, action.value);
        actionModal.show();
    };
    
    // Fonction pour supprimer une action
    window.deleteAction = (index) => {
        if (confirm('Êtes-vous sûr de vouloir supprimer cette action ?')) {
            actions.splice(index, 1);
            renderActionsList();
            Notification.success('Action supprimée');
        }
    };
    
    // Fonction pour déplacer une action
    window.moveAction = (index, direction) => {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= actions.length) return;
        
        const temp = actions[index];
        actions[index] = actions[newIndex];
        actions[newIndex] = temp;
        
        renderActionsList();
    };
    
    // Sauvegarder l'action (ajout ou modification)
    document.getElementById('saveActionBtn').addEventListener('click', () => {
        const actionType = document.getElementById('actionType').value;
        
        if (!actionType) {
            Notification.error('Veuillez sélectionner un type d\'action');
            return;
        }
        
        // Collecter les données du formulaire
        const actionData = {};
        const dynamicFields = document.getElementById('dynamicFields');
        const inputs = dynamicFields.querySelectorAll('input, select, textarea');
        
        // Vérifier les champs requis
        let allRequiredFilled = true;
        inputs.forEach(input => {
            if (input.required && !input.value.trim()) {
                allRequiredFilled = false;
            }
        });
        
        if (!allRequiredFilled) {
            Notification.error('Veuillez remplir tous les champs obligatoires');
            return;
        }
        
        inputs.forEach(input => {
            const value = input.value.trim();
            if (value) {
                // Essayer de parser le JSON si le champ contient du JSON
                if ((input.name === 'headers' || input.name === 'body') && value) {
                    try {
                        actionData[input.name] = JSON.parse(value);
                    } catch (error) {
                        actionData[input.name] = value;
                    }
                } else if (input.type === 'number') {
                    actionData[input.name] = parseInt(value);
                } else {
                    actionData[input.name] = value;
                }
            }
        });
        
        // Récupérer le mapping des variables de sortie
        const outputMapping = {};
        document.querySelectorAll('.output-var-checkbox:checked').forEach(checkbox => {
            const varName = checkbox.dataset.varName;
            const mappingSelect = document.querySelector(`.output-var-mapping[data-var-name="${varName}"]`);
            if (mappingSelect && mappingSelect.value) {
                outputMapping[varName] = mappingSelect.value;
            }
        });
        
        if (Object.keys(outputMapping).length > 0) {
            actionData.output_mapping = outputMapping;
        }
        
        const action = {
            type: actionType,
            value: actionData
        };
        
        if (editingActionIndex >= 0) {
            actions[editingActionIndex] = action;
            Notification.success('Action modifiée avec succès');
        } else {
            actions.push(action);
            Notification.success('Action ajoutée avec succès');
        }
        
        renderActionsList();
        actionModal.hide();
    });
    
    // Soumettre le test
    document.getElementById('submitTestBtn').addEventListener('click', async () => {
        const testName = document.getElementById('testName').value;
        const testDescription = document.getElementById('testDescription').value;
        
        if (!testName) {
            Notification.error('Veuillez saisir un nom pour le test');
            return;
        }
        
        if (actions.length === 0) {
            Notification.error('Veuillez ajouter au moins une action au test');
            return;
        }
        
        const data = {
            campain_id: campainId,
            actions: actions,
            name: testName,
            description: testDescription,
            variables: variables
        };
        
        try {
            const result = await API.post(`/api/tests`, data);
            Notification.success('Test créé avec succès');
            setTimeout(() => {
                window.location.href = `/campains/${campainId}`;
            }, 1000);
        } catch (error) {
            Notification.error('Erreur lors de la création du test: ' + error.message);
        }
    });
    
    // Fonction pour afficher la liste des variables
    function renderVariablesList() {
        const variablesList = document.getElementById('variablesList');
        
        if (variables.length === 0) {
            variablesList.innerHTML = '';
            return;
        }
        
        let html = '<div class="mb-3">';
        html += '<div class="text-muted mb-2"><strong>Variables associées :</strong></div>';
        html += '<div class="d-flex flex-wrap gap-2">';
        
        variables.forEach((variable, index) => {
            html += `
                <span class="badge bg-info d-flex align-items-center" style="font-size: 0.9rem; padding: 0.5rem 0.7rem;">
                    <i class="fas fa-tag me-2"></i>
                    ${variable}
                    <button type="button" class="btn-close btn-close-white ms-2" 
                            onclick="removeVariable(${index})" 
                            style="font-size: 0.6rem;"
                            title="Supprimer"></button>
                </span>
            `;
        });
        
        html += '</div></div>';
        variablesList.innerHTML = html;
    }
    
    // Fonction pour ouvrir le modal d'ajout de variable
    document.getElementById('addVariableBtn').addEventListener('click', () => {
        document.getElementById('variableForm').reset();
        variableModal.show();
    });
    
    // Fonction pour sauvegarder une variable
    document.getElementById('saveVariableBtn').addEventListener('click', () => {
        const variableName = document.getElementById('variableName').value.trim();
        
        if (!variableName) {
            Notification.error('Veuillez saisir un nom de variable');
            return;
        }
        
        // Validation alphanumérique
        const alphanumRegex = /^[a-zA-Z0-9_]+$/;
        if (!alphanumRegex.test(variableName)) {
            Notification.error('Le nom de la variable doit contenir uniquement des caractères alphanumériques et underscore');
            return;
        }
        
        // Vérifier si la variable existe déjà
        if (variables.includes(variableName)) {
            Notification.error('Cette variable existe déjà');
            return;
        }
        
        variables.push(variableName);
        renderVariablesList();
        renderActionsList(); // Actualiser les badges de variables de sortie
        variableModal.hide();
        Notification.success('Variable ajoutée avec succès');
    });
    
    // Fonction pour supprimer une variable
    window.removeVariable = (index) => {
        if (confirm('Êtes-vous sûr de vouloir supprimer cette variable ?')) {
            variables.splice(index, 1);
            renderVariablesList();
            renderActionsList(); // Actualiser les badges de variables de sortie
            Notification.success('Variable supprimée');
        }
    };
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', async () => {
        actionModal = new bootstrap.Modal(document.getElementById('actionModal'));
        variableModal = new bootstrap.Modal(document.getElementById('variableModal'));
        await loadActionMasks();
        await loadActionOutputVariables();
        
        // Initialiser l'autocomplétion des variables
        window.variableAutocomplete = new VariableAutocomplete({
            apiEndpoint: '/api/variables?isRoot=true&page_size=100'
        });
        
        // Mettre à jour les suggestions de variables du test
        updateTestVariablesSuggestions();
    });
    
    /**
     * Met à jour les suggestions de variables du test dans l'autocomplétion
     */
    function updateTestVariablesSuggestions() {
        if (window.variableAutocomplete) {
            window.variableAutocomplete.setVariables('test', variables);
        }
    }
    
    // Fonction originale modifiée pour mettre à jour les suggestions
    const originalRenderVariablesList = renderVariablesList;
    renderVariablesList = function() {
        originalRenderVariablesList();
        updateTestVariablesSuggestions();
    };
    
    const originalRemoveVariable = window.removeVariable;
    window.removeVariable = function(index) {
        originalRemoveVariable(index);
        updateTestVariablesSuggestions();
    };
</script>
{% endblock %}



