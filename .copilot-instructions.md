# Directives de développement - TestGyver

Ce fichier contient les directives et conventions à respecter pour le développement du projet TestGyver.

## 🐍 Commandes Python

### IMPORTANT : Utilisation systématique de python3
- ✅ **TOUJOURS** utiliser `python3` au lieu de `python`
- ✅ **TOUJOURS** utiliser `pip3` au lieu de `pip`
- ✅ Shebang obligatoire : `#!/usr/bin/env python3`
- ✅ Encodage UTF-8 : `# -*- coding: utf-8 -*-`

### Exemples corrects
```bash
python3 script.py
pip3 install package
```

### ❌ À éviter
```bash
python script.py   # NON
pip install package # NON
```

## 📁 Structure du projet

```
app_test/
├── plugins/           # Système de plugins
│   ├── actions/      # Plugins d'actions
│   ├── auth/         # Plugins d'authentification
│   └── reports/      # Plugins de rapports
├── routes/           # Routes Flask (API et Web)
├── models/           # Modèles de données MongoDB
├── utils/            # Utilitaires (auth, db, pagination, workdir)
├── templates/        # Templates Jinja2
├── static/           # Fichiers statiques (CSS, JS, images)
│   └── vendor/       # Bibliothèques tierces locales (pas de CDN)
├── docs/             # Documentation
├── _build/           # Scripts de test et de build
└── workdir/          # Répertoires de travail des campagnes (git-ignored)
```

## 🗄️ Base de données MongoDB

### Collections
- **users** : Utilisateurs de l'application
- **campains** : Campagnes de tests
- **tests** : Tests individuels avec actions et variables
- **rapports** : Rapports d'exécution avec statuts et progression
- **variables** : Variables multi-environnements (avec filières)

### Conventions de nommage
- Utiliser `ObjectId` pour les références
- Convertir les ObjectId en string pour les API JSON
- Format de date : `datetime.utcnow()` et `.isoformat()` pour JSON

## 🔧 Conventions de code Python

### Style
- Suivre PEP 8
- Documentation en **français**
- Docstrings pour toutes les fonctions et classes
- Type hints recommandés

### Exemple de docstring
```python
def ma_fonction(param1, param2):
    """
    Description de la fonction en français.
    
    Args:
        param1: Description du paramètre 1
        param2: Description du paramètre 2
    
    Returns:
        Description du retour
    """
    pass
```

## 🎨 Frontend

### Bibliothèques (locales, pas de CDN)
- Bootstrap 5.3.0 (`static/vendor/bootstrap/`)
- Font Awesome 6.4.0 (`static/vendor/fontawesome/`)
- Socket.IO 4.5.4 (`static/vendor/socket.io/`)

### Templates Jinja2
- Base template : `templates/base.html`
- Utiliser `{{ url_for('static', filename='...') }}` pour les assets
- Variables globales : `app_name`, `app_version`

## 🔌 Système de plugins

### Structure d'un plugin
```python
from plugins.actions.action_base import ActionBase

class MonAction(ActionBase):
    plugin_name = "mon_action"
    version = "1.0.0"
    author = "TestGyver Team"
    
    def get_metadata(self):
        """Retourne les métadonnées."""
        pass
    
    def get_input_mask(self):
        """Retourne le masque de saisie."""
        pass
    
    def execute(self, action_context):
        """Exécute l'action."""
        pass
```

### Types de plugins
- **actions** : Effectuent des opérations (HTTP, WebDAV, SSH, etc.)
- **reports** : Génèrent des rapports
- **auth** : Gèrent l'authentification

## 🚀 API REST

### Format des réponses
```python
# Succès
return jsonify({'message': 'Opération réussie', 'data': data}), 200

# Erreur
return jsonify({'message': 'Description de l\'erreur'}), 400
```

### Authentification
- JWT avec cookies
- Décorateurs : `@token_required`, `@admin_required`
- Expiration configurable dans `configuration.json`

## 📝 Variables et résolution

### Types de variables
1. **testGyver** : Variables globales ({{variable_name}})
2. **test** : Variables du test ({{app.variable_name}})
3. **collection** : Variables système ({{test.test_id}}, {{test.campain_id}})

### Résolution dans les actions
- Les variables sont résolues avant l'exécution
- Format : `{{type.nom_variable}}`

## 🧪 Tests

### Emplacement
- Scripts de test dans `_build/`
- Nommage : `test_*.py`

### Exécution
```bash
python3 _build/test_nom_du_test.py
```

## 📦 Configuration

### Fichier `configuration.json`
```json
{
    "mongo": { ... },
    "jwt_secret": "...",
    "app": { "debug": true, "port": 5000, "host": "0.0.0.0" },
    "pagination": { "page_size": 20, "max_page_size": 100 },
    "security": { "token_expiration_minutes": 60 },
    "workdir": "./workdir",
    "version": "1.0.0"
}
```

## 🔒 Sécurité

- Mots de passe hashés avec bcrypt
- Tokens JWT pour l'authentification
- Validation des entrées utilisateur
- Pas de CDN externes (politique de confidentialité)

## 📊 WebSocket (Flask-SocketIO)

### Événements de campagne
- `campain_started` : Démarrage d'une campagne
- `test_started` : Démarrage d'un test
- `test_completed` : Fin d'un test
- `campain_progress` : Progression de la campagne
- `campain_completed` : Fin de la campagne
- `campain_error` : Erreur lors de l'exécution

## 🗂️ Workdir (répertoires de travail)

### Gestion automatique
- Création lors de la création d'une campagne
- Suppression lors de la suppression d'une campagne
- Nettoyage des orphelins au démarrage
- Chemin : `{workdir}/{campain_id}/`

### Fonctions utilitaires (`utils/workdir.py`)
- `get_workdir()`
- `ensure_workdir_exists()`
- `create_campain_workdir(campain_id)`
- `delete_campain_workdir(campain_id)`
- `get_campain_workdir(campain_id)`

## 📚 Documentation

### Emplacement
- Documentation technique dans `docs/`
- README multilingues (fr, en, es, de, it)

### Mises à jour
- Documenter les nouvelles fonctionnalités
- Mettre à jour `info.txt` avec statut ✅ TERMINÉ

## 🎯 Checklist avant commit

- [ ] Utilisation de `python3` (pas `python`)
- [ ] Shebang `#!/usr/bin/env python3` dans les scripts
- [ ] Encodage `# -*- coding: utf-8 -*-`
- [ ] Documentation en français
- [ ] Docstrings pour les nouvelles fonctions
- [ ] Pas de CDN externes
- [ ] Tests fonctionnels
- [ ] `info.txt` mis à jour si nouvelle fonctionnalité

## 🚫 À éviter absolument

- ❌ Utiliser `python` au lieu de `python3`
- ❌ Utiliser `pip` au lieu de `pip3`
- ❌ Ajouter des CDN externes
- ❌ Documenter en anglais (sauf README internationaux)
- ❌ Commiter le dossier `workdir/`
- ❌ Commiter `__pycache__/` ou `.pyc`
- ❌ Hardcoder des chemins absolus
- ❌ Créer des fichiers markdown de résumé non demandés

---

**Note** : Ce fichier doit être consulté systématiquement lors du développement.
**Date de dernière mise à jour** : 31 octobre 2025
